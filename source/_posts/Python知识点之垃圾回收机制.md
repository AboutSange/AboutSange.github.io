---
title: Python知识点之垃圾回收机制
date: 2019-03-04 11:20:38
description: Python垃圾回收机制采用的是引用计数机制为主，标记-清除和分代回收两种机制为辅的策略
tags: 
- Python
- Python知识点
- 垃圾回收
- GC
categories:  Python
---

## 目录

```
1. 为什么有垃圾回收机制？
2. 引用计数
3. 标记-清除
4. 分代回收
```

![garbage collection](https://raw.githubusercontent.com/AboutSange/img/master/garbage_collection.jpeg)

<!-- more -->

## 正文

### 为什么有垃圾回收机制？

```
众所周知，C/C++中需要自行用malloc动态分配内存并自行free，很容易由于疏忽导致内存泄露；
而Java/Python等语言则通过自动垃圾回收机制把程序员从资源管理的重担中解放出来，“让我用双手成就你的梦想”，GC如是说。
```


### 引用计数

**原理：**

```
每个对象维护一个ob_refcnt字段，用来记录该对象当前被引用的次数，
每当新的引用指向该对象时，它的引用计数ob_ref加1，
每当该对象的引用失效时计数ob_ref减1，
一旦对象的引用计数为0，该对象立即被回收，对象占用的内存空间将被释放。
```

python里每一个东西都是对象，它们的核心就是一个结构体：`PyObject`

```c
typedef struct_object {
    int ob_refcnt;
    struct_typeobject *ob_type;
} PyObject;
```

**优点：**

```
1.简单
2.实时性：一旦没有引用，内存就直接释放了。不用像其他机制等到特定时机。实时性还带来一个好处：处理回收内存的时间分摊到了平时。
```

**缺点：**

```
1.维护引用计数消耗资源
2.无法解决循环引用的问题
```
    
循环引用例子：
```python
list1 = []
list2 = []
list1.append(list2)
list2.append(list1)
```

### 标记-清除

**原理：**

```
GC会把所有的『活动对象』打上标记，第二阶段是把那些没有标记的对象『非活动对象』进行回收。
标记清除算法作为Python的辅助垃圾收集技术主要处理的是一些容器对象，
比如list、dict、tuple，instance等，因为对于字符串、数值对象是不可能造成循环引用问题。
```

那么GC又是如何判断哪些是活动对象哪些是非活动对象的呢？

```
对象之间通过引用（指针）连在一起，构成一个有向图，对象构成这个有向图的节点，而引用关系构成这个有向图的边。
从根对象（root object）出发，沿着有向边遍历对象，可达的（reachable）对象标记为活动对象，不可达的对象就是要被清除的非活动对象。
根对象就是全局变量、调用栈、寄存器。
```


**优点：**

```
1.能解决循环引用的问题
```

**缺点：**

```
1.清除非活动的对象前它必须顺序扫描整个堆内存，哪怕只剩下小部分活动对象也要扫描所有对象。
```

### 分代回收

**原理：**

分代回收是一种以空间换时间的操作方式。Python将内存根据对象的存活时间划分为不同的集合，每个集合称为一个代，Python将内存分为了3“代”，分别为年轻代（第0代）、中年代（第1代）、老年代（第2代），他们对应的是3个链表，它们的垃圾收集频率与对象的存活时间的增大而减小。新创建的对象都会分配在年轻代，年轻代链表的总数达到上限时，Python垃圾收集机制就会被触发，把那些可以被回收的对象回收掉，而那些不会回收的对象就会被移到中年代去，依此类推，老年代中的对象是存活时间最久的对象，甚至是存活于整个系统的生命周期内。同时，分代回收是建立在标记清除技术基础之上。分代回收同样作为Python的辅助垃圾收集技术处理那些容器对象。


## 参考文章

1. [[转载]Python垃圾回收机制--完美讲解! - 简书](https://www.jianshu.com/p/1e375fb40506)
2. [Python中的垃圾回收机制 - FooFish-Python之禅](https://foofish.net/python-gc.html)
